<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Match Predictor</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header with Cricket-themed background -->
    <div class="header">
        <div class="container">
            <h1>IPL Match Predictor</h1>
            <p>Enter match details to predict the winner with AI-powered analysis</p>
        </div>
    </div>

    <div class="container py-8">
        <div class="main-content">
            <!-- Form Section -->
            <div class="card">
                <form method="post">
                    {% csrf_token %}
                    {% load form_filters %}
                    
                    <!-- Match Details -->
                    <div class="form-section">
                        <h2 class="section-title">Match Details</h2>
                        <div class="form-grid form-grid-3">
                            <div class="form-group">
                                <label for="{{ form.venue.id_for_label }}" class="form-label">{{ form.venue.label }}</label>
                                {{ form.venue }}
                                <small class="form-text">Select the stadium where the match is played</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team1.id_for_label }}" class="form-label">{{ form.team1.label }}</label>
                                {{ form.team1 }}
                                <small class="form-text">First competing team</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team2.id_for_label }}" class="form-label">{{ form.team2.label }}</label>
                                {{ form.team2 }}
                                <small class="form-text">Second competing team</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.toss_winner.id_for_label }}" class="form-label">{{ form.toss_winner.label }}</label>
                                {{ form.toss_winner }}
                                <small class="form-text">Team that won the toss</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.toss_decision.id_for_label }}" class="form-label">{{ form.toss_decision.label }}</label>
                                {{ form.toss_decision }}
                                <small class="form-text">Decision after winning the toss</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team 1 Stats -->
                    <div class="form-section">
                        <h2 class="section-title">Team 1 Stats</h2>
                        <p class="form-text mb-3">Enter performance stats from the last 5 matches</p>
                        <div class="form-grid form-grid-3">
                            <div class="form-group">
                                <label for="{{ form.team1_win_rate_last_5.id_for_label }}" class="form-label">{{ form.team1_win_rate_last_5.label }}</label>
                                {{ form.team1_win_rate_last_5 }}
                                <small class="form-text">Value between 0 and 1 (e.g., 0.6 = 3 wins from 5 matches)</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team1_avg_margin_last_5.id_for_label }}" class="form-label">{{ form.team1_avg_margin_last_5.label }}</label>
                                {{ form.team1_avg_margin_last_5 }}
                                <small class="form-text">Average victory margin in runs/wickets</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team1_avg_runs_scored_last_5.id_for_label }}" class="form-label">{{ form.team1_avg_runs_scored_last_5.label }}</label>
                                {{ form.team1_avg_runs_scored_last_5 }}
                                <small class="form-text">Average runs scored per match</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team1_avg_wickets_taken_last_5.id_for_label }}" class="form-label">{{ form.team1_avg_wickets_taken_last_5.label }}</label>
                                {{ form.team1_avg_wickets_taken_last_5 }}
                                <small class="form-text">Average wickets taken per match</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team1_avg_economy_rate_last_5.id_for_label }}" class="form-label">{{ form.team1_avg_economy_rate_last_5.label }}</label>
                                {{ form.team1_avg_economy_rate_last_5 }}
                                <small class="form-text">Average economy rate of bowlers</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team 2 Stats -->
                    <div class="form-section">
                        <h2 class="section-title">Team 2 Stats</h2>
                        <p class="form-text mb-3">Enter performance stats from the last 5 matches</p>
                        <div class="form-grid form-grid-3">
                            <div class="form-group">
                                <label for="{{ form.team2_win_rate_last_5.id_for_label }}" class="form-label">{{ form.team2_win_rate_last_5.label }}</label>
                                {{ form.team2_win_rate_last_5 }}
                                <small class="form-text">Value between 0 and 1 (e.g., 0.6 = 3 wins from 5 matches)</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team2_avg_margin_last_5.id_for_label }}" class="form-label">{{ form.team2_avg_margin_last_5.label }}</label>
                                {{ form.team2_avg_margin_last_5 }}
                                <small class="form-text">Average victory margin in runs/wickets</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team2_avg_runs_scored_last_5.id_for_label }}" class="form-label">{{ form.team2_avg_runs_scored_last_5.label }}</label>
                                {{ form.team2_avg_runs_scored_last_5 }}
                                <small class="form-text">Average runs scored per match</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team2_avg_wickets_taken_last_5.id_for_label }}" class="form-label">{{ form.team2_avg_wickets_taken_last_5.label }}</label>
                                {{ form.team2_avg_wickets_taken_last_5 }}
                                <small class="form-text">Average wickets taken per match</small>
                            </div>
                            <div class="form-group">
                                <label for="{{ form.team2_avg_economy_rate_last_5.id_for_label }}" class="form-label">{{ form.team2_avg_economy_rate_last_5.label }}</label>
                                {{ form.team2_avg_economy_rate_last_5 }}
                                <small class="form-text">Average economy rate of bowlers</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <span class="cricket-ball"></span>
                            Predict Winner
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Prediction Result Section -->
            {% if prediction_result %}
            <div class="card result-section">
                <h2 class="section-title">Match Prediction</h2>
                
                {% if prediction_result.error %}
                    <p class="error-text">Error: {{ prediction_result.error }}</p>
                    <p class="error-details">{{ prediction_result.details }}</p>
                    {% if prediction_result.message %}
                    <p class="error-details">{{ prediction_result.message }}</p>
                    {% endif %}
                    <div class="alert alert-warning mt-4">
                        <p>Please ensure the FastAPI service is running on port 8000.</p>
                        <p class="mt-1">You can start it by running:</p>
                        <code class="code-block">cd c:\Users\anubh\OneDrive\Desktop\ipl_predictor && python fast_api.py</code>
                        <p class="mt-3">Or use the run_servers.py script to start both servers:</p>
                        <code class="code-block">cd c:\Users\anubh\OneDrive\Desktop\ipl_predictor && python run_servers.py</code>
                    </div>
                {% else %}
                    <div class="text-center mb-4">
                        <span class="team-badge">{{ prediction_result.team1 }}</span> vs
                        <span class="team-badge">{{ prediction_result.team2 }}</span>
                    </div>
                    
                    <p class="results-text text-center">
                        The predicted winner is <span class="text-success">{{ prediction_result.winner }}</span>
                    </p>
                    
                    <p class="results-probability text-center">Win probability: <span class="font-bold">{{ prediction_result.probability }}%</span></p>
                    
                    <!-- Prediction Bar Chart -->
                    <div class="progress-container">
                        {% if prediction_result.winner == prediction_result.team1 %}
                            <div class="progress-bar">
                                <div class="progress-segment progress-success" style="width: {{ prediction_result.probability }}%">
                                    {{ prediction_result.team1 }} ({{ prediction_result.probability }}%)
                                </div>
                                <div class="progress-segment progress-danger" style="width: calc(100% - {{ prediction_result.probability }}%)">
                                    {{ prediction_result.team2 }} ({{ 100|add:"-"|add:prediction_result.probability }}%)
                                </div>
                            </div>
                        {% else %}
                            <div class="progress-bar">
                                <div class="progress-segment progress-danger" style="width: calc(100% - {{ prediction_result.probability }}%)">
                                    {{ prediction_result.team1 }} ({{ 100|add:"-"|add:prediction_result.probability }}%)
                                </div>
                                <div class="progress-segment progress-success" style="width: {{ prediction_result.probability }}%">
                                    {{ prediction_result.team2 }} ({{ prediction_result.probability }}%)
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- AI Analysis Button -->
                    <div class="analysis-section">
                        <button id="aiAnalysisBtn" class="btn btn-secondary btn-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-2" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                            Get AI Match Analysis
                        </button>
                        <div id="analysisLoading" class="hidden mt-3 flex items-center loading-text">
                            <div class="spinner"></div>
                            Generating AI analysis...
                        </div>
                    </div>
                    
                    <!-- AI Analysis Result Container -->
                    <div id="aiAnalysisResult" class="hidden analysis-result">
                        <h3 class="analysis-title">AI Match Analysis</h3>
                        <div id="aiAnalysisContent">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Debug Information (Collapsible) -->
                    <div class="debug-section">
                        <button id="debugBtn" class="btn btn-secondary btn-sm">
                            Show Debug Info
                        </button>
                        <div id="debugInfo" class="hidden mt-3">
                            <div class="debug-info">
                                <h5 class="debug-title">Raw API Response:</h5>
                                <pre>{{ prediction_result.raw_response }}</pre>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- JavaScript for Collapsible Debug Info and AI Analysis -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Debug Info Functionality
            const debugBtn = document.getElementById('debugBtn');
            const debugInfo = document.getElementById('debugInfo');
            
            if (debugBtn && debugInfo) {
                debugBtn.addEventListener('click', function() {
                    if (debugInfo.classList.contains('hidden')) {
                        debugInfo.classList.remove('hidden');
                        debugBtn.textContent = 'Hide Debug Info';
                    } else {
                        debugInfo.classList.add('hidden');
                        debugBtn.textContent = 'Show Debug Info';
                    }
                });
            }
            
            // AI Analysis Functionality
            const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
            const analysisLoading = document.getElementById('analysisLoading');
            const aiAnalysisResult = document.getElementById('aiAnalysisResult');
            const aiAnalysisContent = document.getElementById('aiAnalysisContent');
            
            // Add animations for form sections
            const formSections = document.querySelectorAll('.form-section');
            formSections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    section.style.transition = 'all 0.5s ease';
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 100 * (index + 1));
            });
            
            if (aiAnalysisBtn && aiAnalysisResult && aiAnalysisContent) {
                aiAnalysisBtn.addEventListener('click', function() {
                    console.log('AI Analysis button clicked.');
                    // Show loading indicator
                    analysisLoading.classList.remove('hidden');
                    aiAnalysisBtn.disabled = true;
                    aiAnalysisBtn.classList.add('opacity-50');
                    
                    // Prepare data from the current prediction
                    const predictionDataString = '{{ prediction_result_json|escapejs }}';
                    console.log('Raw prediction_result_json string from Django:', predictionDataString);
                    let predictionData = null;
                    try {
                        if (predictionDataString && predictionDataString !== "null") {
                            predictionData = JSON.parse(predictionDataString);
                        }
                    } catch (e) {
                        console.error('Error parsing prediction_result_json:', e, 'String was:', predictionDataString);
                        aiAnalysisContent.innerHTML = '<div class="alert alert-danger"><p class="font-medium">Error: Could not parse prediction data.</p><p>Please check browser console for details.</p></div>';
                        aiAnalysisResult.classList.remove('hidden');
                        analysisLoading.classList.add('hidden');
                        aiAnalysisBtn.disabled = false;
                        aiAnalysisBtn.classList.remove('opacity-50');
                        return;
                    }
                    
                    console.log('Parsed predictionData:', predictionData);

                    if (!predictionData || predictionData.error) {
                        console.log('No valid predictionData available for analysis or predictionData contains an error.');
                        aiAnalysisContent.innerHTML = '<div class="alert alert-danger"><p class="font-medium">Error: No valid prediction data available for analysis.</p><p>Please make a successful prediction first.</p></div>';
                        if (predictionData && predictionData.error) {
                             aiAnalysisContent.innerHTML += `<p class="text-danger mt-1">Details: ${predictionData.details || ''}</p>`;
                        }
                        aiAnalysisResult.classList.remove('hidden');
                        analysisLoading.classList.add('hidden');
                        aiAnalysisBtn.disabled = false;
                        aiAnalysisBtn.classList.remove('opacity-50');
                        return;
                    }
                    
                    // Prepare match data and prediction result objects
                    const matchData = {
                        venue: predictionData.venue || '{{ form.venue.value|default:"" }}',
                        team1: predictionData.team1,
                        team2: predictionData.team2,
                        toss_winner: '{{ form.toss_winner.value|default:"" }}',
                        toss_decision: '{{ form.toss_decision.value|default:"" }}',
                        team1_win_rate_last_5: parseFloat('{{ form.team1_win_rate_last_5.value|default:"0.5" }}'),
                        team1_avg_margin_last_5: parseFloat('{{ form.team1_avg_margin_last_5.value|default:"0.0" }}'),
                        team1_avg_runs_scored_last_5: parseFloat('{{ form.team1_avg_runs_scored_last_5.value|default:"150.0" }}'),
                        team1_avg_wickets_taken_last_5: parseFloat('{{ form.team1_avg_wickets_taken_last_5.value|default:"5.0" }}'),
                        team1_avg_economy_rate_last_5: parseFloat('{{ form.team1_avg_economy_rate_last_5.value|default:"8.0" }}'),
                        team2_win_rate_last_5: parseFloat('{{ form.team2_win_rate_last_5.value|default:"0.5" }}'),
                        team2_avg_margin_last_5: parseFloat('{{ form.team2_avg_margin_last_5.value|default:"0.0" }}'),
                        team2_avg_runs_scored_last_5: parseFloat('{{ form.team2_avg_runs_scored_last_5.value|default:"150.0" }}'),
                        team2_avg_wickets_taken_last_5: parseFloat('{{ form.team2_avg_wickets_taken_last_5.value|default:"5.0" }}'),
                        team2_avg_economy_rate_last_5: parseFloat('{{ form.team2_avg_economy_rate_last_5.value|default:"8.0" }}')
                    };
                    
                    const predictionResult = {
                        winner: predictionData.winner,
                        probability: predictionData.probability
                    };
                    
                    console.log('Prepared matchData for /analyze:', matchData);
                    console.log('Prepared predictionResult for /analyze:', predictionResult);
                    
                    // Fetch AI analysis from FastAPI
                    console.log('Fetching AI analysis from http://127.0.0.1:8000/analyze...');
                    fetch('http://127.0.0.1:8000/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            match_data: matchData,
                            prediction_result: predictionResult
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network response error (${response.status}): ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received AI analysis data:', data);
                        // Format the analysis text for better display
                        let formattedAnalysis = data.analysis
                            .replace(/\n\n/g, '</p><p>') // Replace double newlines with paragraphs
                            .replace(/\n/g, '<br>') // Replace single newlines with line breaks
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                            .replace(/# (.*?)(?:\n|$)/g, '<h4 class="font-bold mt-4 mb-2">$1</h4>') // Headings
                            .replace(/## (.*?)(?:\n|$)/g, '<h5 class="font-bold mt-3 mb-2">$1</h5>'); // Subheadings
                            
                        formattedAnalysis = `<p>${formattedAnalysis}</p>`;
                        
                        // Display the analysis with animation
                        aiAnalysisContent.innerHTML = formattedAnalysis;
                        aiAnalysisResult.style.opacity = '0';
                        aiAnalysisResult.classList.remove('hidden');
                        
                        setTimeout(() => {
                            aiAnalysisResult.style.opacity = '1';
                            // Hide loading indicator
                            analysisLoading.classList.add('hidden');
                            
                            // Change button text to show it's been analyzed
                            aiAnalysisBtn.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="mr-2" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Analysis Complete
                            `;
                            aiAnalysisBtn.disabled = false;
                            aiAnalysisBtn.classList.remove('opacity-50');
                        }, 100);
                    })
                    .catch(error => {
                        console.error('Error fetching AI analysis:', error);
                        aiAnalysisContent.innerHTML = `
                            <div class="alert alert-danger">
                                <p class="font-medium">Error fetching AI analysis</p>
                                <p>${error.message}</p>
                                <p class="mt-2">Make sure the FastAPI server is running and properly configured with a Gemini API key.</p>
                                <button id="retryAnalysisBtn" class="btn btn-secondary btn-sm mt-3">Retry</button>
                            </div>
                        `;
                        aiAnalysisResult.classList.remove('hidden');
                        analysisLoading.classList.add('hidden');
                        aiAnalysisBtn.disabled = false;
                        aiAnalysisBtn.classList.remove('opacity-50');
                        
                        // Add retry button functionality
                        document.getElementById('retryAnalysisBtn').addEventListener('click', function() {
                            aiAnalysisResult.classList.add('hidden');
                            aiAnalysisBtn.click();
                        });
                    });
                });
            }
            
            // Form validation enhancements
            const form = document.querySelector('form');
            if (form) {
                // Highlight fields on focus
                const formInputs = form.querySelectorAll('input, select');
                formInputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        this.parentElement.classList.add('input-focused');
                    });
                    
                    input.addEventListener('blur', function() {
                        this.parentElement.classList.remove('input-focused');
                        // Simple validation - check if field has value
                        if (this.value) {
                            this.classList.add('is-valid');
                            this.classList.remove('is-invalid');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>